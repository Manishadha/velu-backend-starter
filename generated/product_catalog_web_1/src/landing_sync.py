from __future__ import annotations

import json
from pathlib import Path
from typing import Any, Dict


def _repo_root() -> Path:
    # src/landing_sync.py -> parents[1] is repo root
    return Path(__file__).resolve().parents[1]


def _session_path(session_id: str) -> Path:
    safe = "".join(c for c in session_id if c.isalnum() or c in ("-", "_")) or "default"
    return _repo_root() / "data" / "chat_sessions" / f"{safe}.json"


def _load_session(session_id: str) -> Dict[str, Any]:
    p = _session_path(session_id)
    if not p.exists():
        raise FileNotFoundError(f"Session file not found: {p}")
    return json.loads(p.read_text(encoding="utf-8"))


def _generate_index_tsx(spec: Dict[str, Any], summary: str | None) -> str:
    module = spec.get("module_name") or "app"
    product_type = spec.get("product_type", "product")
    goal = spec.get("goal", "")
    features = spec.get("main_features") or []
    pages = spec.get("pages") or []
    target_users = spec.get("target_users", "")
    design_style = spec.get("design_style", "")
    frontend = spec.get("frontend", "nextjs")
    backend = spec.get("backend", "fastapi")
    database = spec.get("database", "sqlite")

    title = f"{module} – {goal.capitalize() or 'Generated App'}".strip()
    hero_line = goal or f"Auto-generated {product_type} by Velu"

    if features:
        features_list = "".join(f"\n            <li>{f}</li>" for f in features)
    else:
        features_list = "\n            <li>First core feature</li>"

    if pages:
        pages_list = "".join(f"\n            <li><strong>{p}</strong></li>" for p in pages)
    else:
        pages_list = "\n            <li><strong>Home</strong></li>"

    summary_block = ""
    if summary:
        # We don't escape summary here; it's plain text inside <pre>
        indented_summary = "\n".join("            " + line for line in summary.splitlines())
        summary_block = f"""
        <section className="mb-7">
          <h2 className="text-lg font-semibold mb-2">Project summary</h2>
          <pre className="text-sm bg-slate-50 rounded-xl p-3 border border-slate-200 whitespace-pre-wrap text-slate-700">
{indented_summary}
          </pre>
        </section>"""

    return f"""import React from "react";

export default function Home() {{
  return (
    <main className="min-h-screen bg-slate-50 py-10 px-4 flex justify-center">
      <div className="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-slate-200 p-8">
        <p className="text-[0.7rem] uppercase tracking-[0.2em] text-slate-500 mb-2">
          {module} • {product_type} • {frontend.capitalize()} + {backend.capitalize()} + {database.capitalize()}
        </p>
        <h1 className="text-2xl font-bold mb-1">
          {title}
        </h1>
        <p className="text-sm text-slate-600 mb-6">
          {hero_line}
        </p>

        <section className="mb-7">
          <h2 className="text-lg font-semibold mb-1">Core features</h2>
          <p className="text-sm text-slate-600 mb-1">
            These are the main things this <strong>{module}</strong> {product_type} should do:
          </p>
          <ul className="list-disc list-inside text-sm text-slate-900">
            {features_list}
          </ul>
        </section>

        <section className="mb-7">
          <h2 className="text-lg font-semibold mb-1">Planned pages</h2>
          <p className="text-sm text-slate-600 mb-1">
            Based on the Velu conversation, these pages are part of the plan:
          </p>
          <ul className="list-disc list-inside text-sm text-slate-900">
            {pages_list}
          </ul>
        </section>{summary_block}

        <section>
          <h2 className="text-lg font-semibold mb-1">Tech &amp; next steps</h2>
          <p className="text-sm text-slate-600 mb-1">
            This project was generated by Velu with the following stack:
          </p>
          <ul className="list-disc list-inside text-sm text-slate-900">
            <li>Frontend: <strong>{frontend.capitalize()}</strong></li>
            <li>Backend: <strong>{backend.capitalize()}</strong></li>
            <li>Database: <strong>{database.capitalize()}</strong></li>
          </ul>

          <p className="text-sm text-slate-600 mt-2">
            You can now:
          </p>
          <ul className="list-disc list-inside text-sm text-slate-900">
            <li>Connect pages to real API endpoints and the database</li>
            <li>Implement business logic like cart, checkout, or dashboards</li>
            <li>Add authentication / roles for {target_users or "your users"}</li>
            <li>Iterate with Velu for the next version of this {product_type}</li>
          </ul>

          <p className="text-xs text-slate-500 mt-4">
            Design preference: {design_style or "not specified yet"}.
          </p>
        </section>
      </div>
    </main>
  );
}}
"""


def sync_frontend(session_id: str) -> None:
    session = _load_session(session_id)
    spec = session.get("spec") or {}
    summary = session.get("project_summary") or None

    content = _generate_index_tsx(spec, summary)
    out_path = _repo_root() / "generated" / "web" / "pages" / "index.tsx"
    out_path.parent.mkdir(parents=True, exist_ok=True)
    out_path.write_text(content, encoding="utf-8")
    print(f"[landing_sync] Wrote landing page from session '{session_id}' to {out_path}")


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(
        description="Sync Next.js landing page from Velu session spec."
    )
    parser.add_argument("--session-id", required=True, help="Chat session id, e.g. shop_v2")
    args = parser.parse_args()

    sync_frontend(args.session_id)
